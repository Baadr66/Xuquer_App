<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Reseteo universal: elimina m√°rgenes, padding y configura box-sizing para todos los elementos */
    * { 
        margin: 0; /* Elimina todos los m√°rgenes por defecto */
        padding: 0; /* Elimina todos los paddings por defecto */
        box-sizing: border-box; /* Hace que width y height incluyan padding y border */
    }

    /* Estilos del body (cuerpo de la p√°gina) */
    body { 
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Define la fuente principal */
        background: #f5f5f5; /* Color de fondo gris claro */
        font-size: 13px; /* Tama√±o de fuente base */
        overflow-x: hidden; /* Oculta el scroll horizontal si hay contenido que se desborda */
    }

    /* Cabecera principal de la p√°gina */
    .header { 
        background: #2b579a; /* Color de fondo azul oscuro */
        color: white; /* Color de texto blanco */
        padding: 8px 12px; /* Espaciado interno: 8px arriba/abajo, 12px izquierda/derecha */
        display: flex; /* Usa flexbox para alinear elementos */
        align-items: center; /* Centra verticalmente los elementos */
        gap: 10px; /* Espacio de 10px entre elementos flexbox */
        box-shadow: 0 2px 4px rgba(0,0,0,0.2); /* Sombra: 2px hacia abajo, 4px difuminado, negro 20% opacidad */
    }

    /* Bot√≥n de volver */
    .volver-btn { 
        background: rgba(255,255,255,0.2); /* Fondo blanco con 20% de opacidad (transl√∫cido) */
        color: white; /* Texto blanco */
        padding: 5px 10px; /* Espaciado interno: 5px arriba/abajo, 10px izquierda/derecha */
        text-decoration: none; /* Elimina el subrayado del enlace */
        border-radius: 3px; /* Bordes redondeados de 3px */
        font-size: 12px; /* Tama√±o de fuente peque√±o */
        border: 1px solid rgba(255,255,255,0.3); /* Borde blanco con 30% opacidad */
    }

    /* Estado hover (al pasar el rat√≥n) del bot√≥n volver */
    .volver-btn:hover { 
        background: rgba(255,255,255,0.3); /* Aumenta la opacidad del fondo a 30% */
    }

    /* Barra de herramientas */
    .toolbar {
        background: #217346; /* Color verde oscuro (estilo Excel) */
        color: white; /* Texto blanco */
        padding: 6px 12px; /* Espaciado interno: 6px arriba/abajo, 12px izquierda/derecha */
        font-size: 12px; /* Tama√±o de fuente peque√±o */
        display: flex; /* Usa flexbox */
        justify-content: space-between; /* Distribuye elementos en los extremos */
        align-items: center; /* Centra verticalmente */
    }

    /* Contenedor de b√∫squeda */
    .search-container {
        background: white; /* Fondo blanco */
        padding: 8px 12px; /* Espaciado interno */
        border-bottom: 2px solid #217346; /* Borde inferior verde de 2px */
    }

    /* Input de b√∫squeda dentro del contenedor */
    .search-container input {
        width: 100%; /* Ocupa todo el ancho disponible */
        padding: 6px 10px; /* Espaciado interno */
        border: 1px solid #d0d0d0; /* Borde gris claro */
        font-size: 13px; /* Tama√±o de fuente */
        border-radius: 2px; /* Bordes ligeramente redondeados */
    }

    /* Contenedor de la tabla con scroll horizontal */
    .table-container {
        overflow-x: auto; /* Permite scroll horizontal si la tabla es muy ancha */
        background: white; /* Fondo blanco */
    }

    /* Estilos de la tabla */
    table {
        width: 100%; /* La tabla ocupa todo el ancho del contenedor */
        border-collapse: collapse; /* Elimina espacios entre bordes de celdas */
        background: white; /* Fondo blanco */
    }

    /* Cabecera de la tabla (thead) */
    thead {
        background: #217346; /* Fondo verde (estilo Excel) */
        color: white; /* Texto blanco */
        position: sticky; /* La cabecera permanece fija al hacer scroll */
        top: 0; /* Se pega a la parte superior */
        z-index: 10; /* Aparece por encima de otros elementos */
    }

    /* Celdas de encabezado (th) */
    th {
        padding: 8px 6px; /* Espaciado interno */
        text-align: left; /* Alinea el texto a la izquierda */
        font-weight: 600; /* Texto semi-negrita */
        font-size: 11px; /* Tama√±o de fuente peque√±o */
        border: 1px solid #1a5c37; /* Borde verde m√°s oscuro */
        white-space: nowrap; /* Evita que el texto se divida en m√∫ltiples l√≠neas */
    }

    /* Celdas de datos (td) */
    td {
        padding: 4px 6px; /* Espaciado interno reducido */
        border: 1px solid #d0d0d0; /* Borde gris claro */
        background: white; /* Fondo blanco */
        vertical-align: top; /* Alinea el contenido en la parte superior */
    }

    /* Efecto hover en las filas: cambia color al pasar el rat√≥n */
    tr:hover td {
        background: #fff9e6; /* Fondo amarillo claro al pasar el rat√≥n */
    }

    /* Celda de encabezado de fila (n√∫meros de fila estilo Excel) */
    .row-header {
        background: #f0f0f0; /* Fondo gris claro */
        font-weight: 600; /* Texto semi-negrita */
        font-size: 11px; /* Tama√±o de fuente peque√±o */
        text-align: center; /* Texto centrado */
        width: 40px; /* Ancho fijo de 40px */
        color: #444; /* Color de texto gris oscuro */
    }

    /* Estilos para inputs de texto, selects y textareas */
    input[type="text"], select, textarea {
        width: 100%; /* Ocupa todo el ancho disponible */
        padding: 3px 5px; /* Espaciado interno m√≠nimo */
        border: 1px solid #d0d0d0; /* Borde gris claro */
        font-size: 12px; /* Tama√±o de fuente */
        font-family: inherit; /* Hereda la fuente del padre */
        background: white; /* Fondo blanco */
    }

    /* Estado focus (cuando el usuario hace clic en el input) */
    input[type="text"]:focus, select:focus, textarea:focus {
        outline: 2px solid #217346; /* Borde verde de 2px cuando est√° activo */
        border-color: #217346; /* Cambia el color del borde a verde */
    }

    /* Estilos espec√≠ficos para select */
    select {
        padding: 3px 3px; /* Padding reducido para selects */
    }

    /* Estilos espec√≠ficos para textarea */
    textarea {
        min-height: 40px; /* Altura m√≠nima de 40px */
        resize: vertical; /* Permite redimensionar solo verticalmente */
        font-family: inherit; /* Hereda la fuente del padre */
    }

    /* Celda que contiene botones */
    .btn-cell {
        text-align: center; /* Centra el contenido */
        white-space: nowrap; /* Evita saltos de l√≠nea */
        width: 200px; /* Ancho fijo de 200px */
    }

    /* Grupo de botones alineados horizontalmente */
    .btn-group {
        display: flex; /* Usa flexbox */
        gap: 3px; /* Espacio de 3px entre botones */
        justify-content: center; /* Centra los botones */
    }

    /* Estilos base para todos los botones */
    .btn {
        padding: 4px 8px; /* Espaciado interno */
        border: none; /* Sin borde */
        border-radius: 2px; /* Bordes ligeramente redondeados */
        font-size: 11px; /* Tama√±o de fuente peque√±o */
        cursor: pointer; /* Cambia el cursor a manita al pasar por encima */
        color: white; /* Texto blanco */
        font-weight: 500; /* Texto medio-negrita */
        white-space: nowrap; /* Evita saltos de l√≠nea en el texto del bot√≥n */
    }

    /* Efecto hover gen√©rico para botones */
    .btn:hover { 
        opacity: 0.85; /* Reduce la opacidad a 85% al pasar el rat√≥n */
    }

    /* Bot√≥n de guardar (verde) */
    .btn-save { 
        background: #217346; /* Fondo verde */
    }

    /* Bot√≥n de eliminar (rojo) */
    .btn-delete { 
        background: #c00000; /* Fondo rojo */
    }

    /* Bot√≥n de detalles (azul) */
    .btn-details { 
        background: #0078d4; /* Fondo azul */
    }

    /* Fila expandida (cuando se muestran detalles) */
    .expanded-row {
        background: #f8f8f8; /* Fondo gris muy claro */
    }

    /* Contenido de la fila expandida */
    .expanded-content {
        padding: 8px; /* Espaciado interno */
        display: grid; /* Usa CSS Grid */
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); /* Columnas responsivas: m√≠nimo 250px, se ajustan autom√°ticamente */
        gap: 8px; /* Espacio de 8px entre elementos del grid */
    }

    /* Grupo de campo (label + input) */
    .field-group {
        display: flex; /* Usa flexbox */
        flex-direction: column; /* Apila elementos verticalmente */
        gap: 3px; /* Espacio de 3px entre label e input */
    }

    /* Etiqueta de campo */
    .field-label {
        font-size: 11px; /* Tama√±o de fuente peque√±o */
        font-weight: 600; /* Texto semi-negrita */
        color: #444; /* Color gris oscuro */
    }

    /* Bot√≥n flotante para agregar fila (FAB - Floating Action Button) */
    .add-row-btn {
        position: fixed; /* Posici√≥n fija en la pantalla */
        bottom: 20px; /* 20px desde el borde inferior */
        right: 20px; /* 20px desde el borde derecho */
        width: 50px; /* Ancho de 50px */
        height: 50px; /* Alto de 50px (bot√≥n circular) */
        border-radius: 50%; /* Hace el bot√≥n completamente circular */
        background: #217346; /* Fondo verde */
        color: white; /* Texto/icono blanco */
        border: none; /* Sin borde */
        font-size: 24px; /* Tama√±o de fuente grande para el s√≠mbolo + */
        cursor: pointer; /* Cursor de manita */
        box-shadow: 0 4px 8px rgba(0,0,0,0.3); /* Sombra: 4px abajo, 8px difuminado, negro 30% */
        z-index: 100; /* Aparece por encima de otros elementos */
    }

    /* Efecto hover del bot√≥n flotante */
    .add-row-btn:hover {
        background: #1a5c37; /* Verde m√°s oscuro */
        transform: scale(1.05); /* Aumenta el tama√±o 5% */
    }

    /* Modal (ventana emergente) - oculto por defecto */
    .modal {
        display: none; /* Oculto inicialmente */
        position: fixed; /* Posici√≥n fija que cubre toda la pantalla */
        top: 0; /* Desde arriba */
        left: 0; /* Desde la izquierda */
        width: 100%; /* Ancho completo */
        height: 100%; /* Alto completo */
        background: rgba(0,0,0,0.5); /* Fondo negro semi-transparente (overlay) */
        z-index: 1000; /* Aparece por encima de todo */
    }

    /* Contenido del modal (caja blanca) */
    .modal-content {
        background: white; /* Fondo blanco */
        margin: 5% auto; /* 5% desde arriba, centrado horizontalmente */
        padding: 0; /* Sin padding (se aplica a secciones internas) */
        width: 90%; /* 90% del ancho de la pantalla */
        max-width: 600px; /* Ancho m√°ximo de 600px */
        border-radius: 4px; /* Bordes redondeados */
        box-shadow: 0 4px 20px rgba(0,0,0,0.3); /* Sombra pronunciada */
    }

    /* Cabecera del modal */
    .modal-header {
        background: #217346; /* Fondo verde */
        color: white; /* Texto blanco */
        padding: 12px 15px; /* Espaciado interno */
        display: flex; /* Usa flexbox */
        justify-content: space-between; /* T√≠tulo a la izquierda, bot√≥n cerrar a la derecha */
        align-items: center; /* Centra verticalmente */
    }

    /* T√≠tulo del modal */
    .modal-title {
        font-size: 16px; /* Tama√±o de fuente */
        font-weight: 600; /* Texto semi-negrita */
    }

    /* Bot√≥n de cerrar modal (X) */
    .close-btn {
        background: transparent; /* Sin fondo */
        border: none; /* Sin borde */
        color: white; /* S√≠mbolo blanco */
        font-size: 24px; /* Tama√±o grande */
        cursor: pointer; /* Cursor de manita */
        width: 30px; /* Ancho */
        height: 30px; /* Alto */
    }

    /* Cuerpo del modal (contenido principal) */
    .modal-body {
        padding: 15px; /* Espaciado interno */
    }

    /* Fila de formulario */
    .form-row {
        margin-bottom: 12px; /* Espacio entre campos del formulario */
    }

    /* Etiqueta de formulario */
    .form-label {
        display: block; /* Ocupa toda la l√≠nea */
        font-weight: 600; /* Texto semi-negrita */
        margin-bottom: 4px; /* Espacio debajo de la etiqueta */
        font-size: 12px; /* Tama√±o de fuente */
        color: #333; /* Color gris oscuro */
    }

    /* Control de formulario (input) */
    .form-control {
        width: 100%; /* Ancho completo */
        padding: 6px 8px; /* Espaciado interno */
        border: 1px solid #d0d0d0; /* Borde gris claro */
        font-size: 13px; /* Tama√±o de fuente */
        border-radius: 2px; /* Bordes ligeramente redondeados */
    }

    /* Estado focus de controles de formulario */
    .form-control:focus {
        outline: 2px solid #217346; /* Borde verde de 2px */
        border-color: #217346; /* Cambia color del borde a verde */
    }

    /* Pie del modal */
    .modal-footer {
        padding: 12px 15px; /* Espaciado interno */
        background: #f5f5f5; /* Fondo gris claro */
        border-top: 1px solid #d0d0d0; /* Borde superior gris */
        text-align: right; /* Alinea contenido a la derecha */
    }

    /* Bot√≥n de env√≠o de formulario */
    .btn-submit {
        background: #217346; /* Fondo verde */
        color: white; /* Texto blanco */
        padding: 8px 20px; /* Espaciado interno */
        border: none; /* Sin borde */
        border-radius: 2px; /* Bordes ligeramente redondeados */
        font-size: 13px; /* Tama√±o de fuente */
        cursor: pointer; /* Cursor de manita */
        font-weight: 600; /* Texto semi-negrita */
    }

    /* Efecto hover del bot√≥n submit */
    .btn-submit:hover {
        background: #1a5c37; /* Verde m√°s oscuro */
    }

    /* Celda con informaci√≥n que puede ser muy larga */
    .info-cell {
        max-width: 150px; /* Ancho m√°ximo de 150px */
        overflow: hidden; /* Oculta el contenido que se desborda */
        text-overflow: ellipsis; /* Muestra "..." cuando el texto es muy largo */
        white-space: nowrap; /* Evita saltos de l√≠nea */
    }

    /* Media query: estilos para pantallas peque√±as (m√≥viles) */
    @media (max-width: 768px) {
        /* Reduce tama√±os en pantallas menores a 768px */
        th, td {
            font-size: 11px; /* Fuente m√°s peque√±a */
            padding: 3px 4px; /* Padding reducido */
        }
        .btn {
            padding: 3px 6px; /* Botones m√°s peque√±os */
            font-size: 10px; /* Fuente m√°s peque√±a */
        }
    }
    </style>
</head>
<body>

    <div class="header">
        <a href="/cabecera" class="volver-btn">‚Üê Volver</a>
        <strong>{{ username.capitalize() }}</strong>
    </div>

    <div class="toolbar">
        <span>üìã {{ referencia }}</span>
        <span id="recordCount">Registros: {{ detalles|length }}</span>
    </div>

    <div class="search-container">
        <input type="text" id="searchDetalles" placeholder="üîç Buscar en todos los campos..." />
        <select id="filterTipo" class="form-control" style="margin-top: 8px;">
            <option value="">-- Filtrar por Tipo --</option>
            {% for ref in referencias_tipo %}
                <option value="{{ ref[0] }}">{{ ref[1] }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="table-container">
        <table id="dataTable">
            <thead>
                <tr>
                    <th style="min-width: 150px;">Tipo</th>
                    <th style="min-width: 150px;">Referencia</th>
                    <th style="width: 200px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="tableBody">
                {% for det in detalles %}
                <tr data-id="{{ det[0] }}">
                    <td>
                        <form id="form-{{ det[0] }}" action="/actualizar_det/{{ det[0] }}" method="post" style="margin: 0;">
                            <select name="id_infotipo" required>
                                {% for ref in referencias_tipo %}
                                    <option value="{{ ref[0] }}" {% if ref[0] == det[1] %}selected{% endif %}>{{ ref[1] }}</option>
                                {% endfor %}
                            </select>
                    </td>
                    <td>
                        <input type="text" name="referencia" value="{{ det[2] }}" required>
                        <input type="hidden" name="id_infocab" value="{{ det[7] }}">
                    </td>
                    <td class="btn-cell">
                        <div class="btn-group">
                            <button type="button" class="btn btn-details" onclick="toggleDetails({{ det[0] }})">+Info</button>
                            <button type="submit" class="btn btn-save">üíæ</button>
                            <button type="button" class="btn btn-delete" onclick="eliminar({{ det[0] }})">üóë</button>
                        </div>
                        </form>
                        <form id="del-{{ det[0] }}" action="/eliminar_det/{{ det[0] }}" method="post" style="display:none;">
                            <input type="hidden" name="id_infocab" value="{{ det[7] }}">
                        </form>
                    </td>
                </tr>
                <tr id="details-{{ det[0] }}" class="expanded-row" style="display: none;">
                    <td colspan="6">
                        <div class="expanded-content">
                            <div class="field-group">
                                <label class="field-label">Descripci√≥n 1</label>
                                <textarea form="form-{{ det[0] }}" name="desc1" placeholder="Descripci√≥n 1">{{ det[3] }}</textarea>
                            </div>
                            <div class="field-group">
                                <label class="field-label">Descripci√≥n 2</label>
                                <textarea form="form-{{ det[0] }}" name="desc2" placeholder="Descripci√≥n 2">{{ det[4] }}</textarea>
                            </div>
                            <div class="field-group">
                                <label class="field-label">Notas</label>
                                <textarea form="form-{{ det[0] }}" name="notas" placeholder="Notas">{{ det[5] }}</textarea>
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <button class="add-row-btn" onclick="openModal()">+</button>

    <div id="addModal" class="modal" onclick="closeModalOutside(event)">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-header">
                <div class="modal-title">‚ûï Agregar Nuevo Registro</div>
                <button class="close-btn" onclick="closeModal()">√ó</button>
            </div>
            
            <form action="/agregar_det" method="post">
                <div class="modal-body">
                    <input type="hidden" name="id_infocab" value="{{ detalles[0][7] if detalles else '' }}">
                    
                    <div class="form-row">
                        <label class="form-label">Tipo *</label>


                        <select name="id_infotipo" class="form-control" required>
                            <option value="" disabled selected>Seleccionar tipo...</option>
                            {% for ref in referencias_tipo %}
                                <P> {{ ref }}</P>
                                <option value="{{ ref[0] }}">{{ ref[1] }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-row">
                        <label class="form-label">Referencia *</label>
                        <input type="text" name="referencia" class="form-control" placeholder="Ingrese referencia" required>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Descripci√≥n 1</label>
                        <textarea name="desc1" class="form-control" placeholder="Descripci√≥n 1 (opcional)" rows="2"></textarea>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Descripci√≥n 2</label>
                        <textarea name="desc2" class="form-control" placeholder="Descripci√≥n 2 (opcional)" rows="2"></textarea>
                    </div>

                    <div class="form-row">
                        <label class="form-label">Notas</label>
                        <textarea name="notas" class="form-control" placeholder="Notas adicionales (opcional)" rows="2"></textarea>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="submit" class="btn-submit">Agregar Registro</button>
                </div>
            </form>
        </div>
    </div>

<script>

    const tipos = [
        {% for ref in referencias_tipo %}
            { id: "{{ ref[0] }}", nombre: "{{ ref[1] }}" },
        {% endfor %}
    ];

    const tipo = document.getElementById("filterTipo");
    const datos_Busqueda = {
        referencia: "{{ referencia }}",
        tipo: ""
    }


    tipo.addEventListener("change", function() {
        console.log("Filtro cambiado a:", this.value);
        datos_Busqueda.tipo = this.value;
        console.log("Datos de b√∫squeda actualizados:", datos_Busqueda);
        document.getElementById('searchDetalles').dispatchEvent(new Event('keyup'));
    });




    function toggleDetails(id) {
        const detailsRow = document.getElementById("details-" + id);
        const isVisible = detailsRow.style.display !== "none";
        detailsRow.style.display = isVisible ? "none" : "table-row";
    }

    function eliminar(id) {
        if (confirm("¬øEst√° seguro de eliminar este registro?")) {
            document.getElementById("del-" + id).submit();
        }
    }

    function openModal() {
        document.getElementById("addModal").style.display = "block";
    }

    function closeModal() {
        document.getElementById("addModal").style.display = "none";
    }

    function closeModalOutside(event) {
        if (event.target.id === "addModal") {
            closeModal();
        }
    }

    function renderRow(det, index) {
        let options = tipos.map(t =>
            `<option value="${t.id}" ${t.id == det.id_infotipo ? "selected" : ""}>${t.nombre}</option>`
        ).join("");

        return `<tr data-id="${det.id}">
                    <td>
                        <form id="form-${det.id}" action="/actualizar_det/${det.id}" method="post" style="margin: 0;">
                            <select name="id_infotipo" required>
                                ${options}
                            </select>
                    </td>
                    <td>
                        <input type="text" name="referencia" value="${det.referencia}" required>
                        <input type="hidden" name="id_infocab" value="${det.id_infocab}">
                    </td>
                    <td class="btn-cell">
                        <div class="btn-group">
                            <button type="button" class="btn btn-details" onclick="toggleDetails(${det.id})">+Info</button>
                            <button type="submit" class="btn btn-save">üíæ</button>
                            <button type="button" class="btn btn-delete" onclick="eliminar(${det.id})">üóë</button>
                        </div>
                        </form>
                        <form id="del-${det.id}" action="/eliminar_det/${det.id}" method="post" style="display:none;">
                            <input type="hidden" name="id_infocab" value="${det.id_infocab}">
                        </form>
                    </td>
                </tr>
                <tr id="details-${det.id}" class="expanded-row" style="display: none;">
                    <td colspan="6">
                        <div class="expanded-content">
                            <div class="field-group">
                                <label class="field-label">Descripci√≥n 1</label>
                                <textarea form="form-${det.id}" name="desc1" placeholder="Descripci√≥n 1">${det.desc1 || ""}</textarea>
                            </div>
                            <div class="field-group">
                                <label class="field-label">Descripci√≥n 2</label>
                                <textarea form="form-${det.id}" name="desc2" placeholder="Descripci√≥n 2">${det.desc2 || ""}</textarea>
                            </div>
                            <div class="field-group">
                                <label class="field-label">Notas</label>
                                <textarea form="form-${det.id}" name="notas" placeholder="Notas">${det.notas || ""}</textarea>
                            </div>
                        </div>
                    </td>
                </tr>`;
    }

    console.log("Configuraci√≥n inicial de b√∫squeda:", datos_Busqueda);
    
    document.getElementById("searchDetalles").addEventListener("keyup", async function () {
        const q = this.value.trim(); // Valor del input de b√∫squeda
        const tipoFiltro = datos_Busqueda.tipo; // Tipo seleccionado

        const response = await fetch(`/api/detalles?referencia=${encodeURIComponent(datos_Busqueda.referencia)}&q=${encodeURIComponent(q)}&tipo=${encodeURIComponent(tipoFiltro)}`);
        console.log("Respuesta recibida del servidor para b√∫squeda de detalles.");
        console.log(response);
        const data = await response.json();
        const contenedor = document.getElementById("tableBody");
        contenedor.innerHTML = "";
        if (data.length === 0) {
            contenedor.innerHTML = '<tr><td colspan="3">No se encontraron resultados.</td></tr>';
        } else {
            data.forEach((det, index) => {
                contenedor.innerHTML += renderRow(det, index);
            });
        }
        document.getElementById("recordCount").innerText = `Registros: ${data.length}`;

    });

</script>

</body>
</html>